/**
*  RT
*  unified client-side real-time communication using (xhr) polling / bosh / (web)sockets
*  RT Poll Client
*
*  @version: 0.1.0
*  https://github.com/foo123/RT
*
**/
!function(e,l){"use strict";"object"==typeof exports?l(require("./RT.js")):l(e.RT)&&"function"==typeof define&&define.amd&&define(function(){return e.RT})}(this,function(e){"use strict";var l="prototype",t=(Object[l].toString,e.Client[l]),n=e.Util,r=e.XHR;return e.Client.Poll=function o(e){var l=this;return l instanceof o?(t.constructor.call(l,e),l.$cfg$.pollInterval=l.$cfg$.pollInterval||1e3,l.$timer$=null,l.$xhr$=null,l.$mID$=0,void(l.$queue$=[])):new o(e)},e.Client.Impl.poll=e.Client.Impl["short-poll"]=e.Client.Poll,e.Client.Poll[l]=Object.create(t),e.Client.Poll[l].constructor=e.Client.Poll,e.Client.Poll[l].$timer$=null,e.Client.Poll[l].$xhr$=null,e.Client.Poll[l].$queue$=null,e.Client.Poll[l].$mID$=null,e.Client.Poll[l].dispose=function(){var e=this;return e.abort(),e.$mID$=null,e.$queue$=null,t.dispose.call(e)},e.Client.Poll[l].abort=function(e){var l=this;return l.$timer$&&(clearTimeout(l.$timer$),l.$timer$=null),l.$xhr$&&(l.$xhr$.abort(!0===e),l.$xhr$=null),l},e.Client.Poll[l].$poll$=function(l){var t=this,o=function i(){var l={"Content-Type":"application/x-www-form-urlencoded; charset=utf8","X-RT--Poll":"1","X-RT--Receive":"1","X-RT--mID":t.$mID$},o=null,$=null;t.$queue$.length&&(l["X-RT--Send"]="1",l["X-RT--Message"]=o=e.UUID("----------------------"),$=t.$queue$.slice()),t.$xhr$=r.create({url:t.$cfg$.url+(-1<t.$cfg$.url.indexOf("?")?"&":"?")+"__nocache__="+(new Date).getTime(),method:"POST",responseType:"text",headers:l,onError:function(e){t.emit("error",e.statusText)},onTimeout:function(){t.$timer$=setTimeout(i,t.$cfg$.pollInterval)},onComplete:function(e){var l=e.responseHeader("X-RT--Message"),n=e.responseHeader("X-RT--Close"),r=e.responseHeader("X-RT--Error"),o=e.responseHeader("X-RT--mID");if(r)return void t.emit("error",r);if(n)return void t.close();if(l){var $,u,s=(e.responseText||"").split(l);for($=0,u=s.length;u>$;$++)t.emit("receive",s[$])}o&&(t.$mID$=o),s&&t.$queue$.splice(0,s.length),t.$timer$=setTimeout(i,t.$cfg$.pollInterval)}},$?"rt_payload="+n.Url.encode($.join(o)):null)};return t.$timer$=setTimeout(o,!0===l?0:t.$cfg$.pollInterval),t},e.Client.Poll[l].send=function(e){var l=this;return l.$queue$.push(String(e)),l},e.Client.Poll[l].listen=function(){var e=this;return e.emit("open").$poll$(!0)},e});