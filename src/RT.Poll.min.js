/**
*  RT
*  unified client-side real-time communication using (xhr) polling / bosh / (web)sockets / webrtc for Node/XPCOM/JS
*  RT Poll Client
*
*  @version: 1.0.1
*  https://github.com/foo123/RT
*
**/
!function(e,t){"use strict";"object"==typeof module&&module.exports?module.exports=t.call(e,module.$deps&&module.$deps.RT||require("./RT")):"function"==typeof define&&define.amd&&"function"==typeof require&&"function"==typeof require.specified&&require.specified("RT_Poll")?define("RT_Poll",["module","RT"],function(r,n){return t.moduleUri=r.uri,t.call(e,n),n}):(t.call(e,e.RT)||1)&&"function"==typeof define&&define.amd&&define(function(){return e.RT})}(this,function(e){"use strict";var t="prototype",r=(Object[t].toString,e.Client),n=r[t],l=e.Util,o=e.XHR,i=r.Poll=function $(e){var t=this;return t instanceof $?(n.constructor.call(t,e),t.$cfg$.pollInterval=t.$cfg$.pollInterval||1e3,t.$timer$=null,t.$xhr$=null,t.$mID$=0,void(t.$queue$=[])):new $(e)};return r.Impl.poll=r.Impl["short-poll"]=i,i[t]=Object.create(n),i[t].constructor=i,i[t].$timer$=null,i[t].$xhr$=null,i[t].$queue$=null,i[t].$mID$=null,i[t].dispose=function(){var e=this;return e.$timer$&&(clearTimeout(e.$timer$),e.$timer$=null),e.$xhr$&&(e.$xhr$.abort().dispose(),e.$xhr$=null),e.$mID$=null,e.$queue$=null,n.dispose.call(e)},i[t].abort=function(e){var t=this;return t.$timer$&&(clearTimeout(t.$timer$),t.$timer$=null),t.$xhr$&&(t.$xhr$.abort().dispose(),t.$xhr$=null),n.abort.call(t,!0===e)},i[t].send=function(e){var t=this;return t.$queue$.push(String(e)),t},i[t].listen=function(){var t=this,r=function n(){var r="urlencoded"===t.$cfg$.contentType,i="xml"===t.$cfg$.contentType,$=t.$cfg$.charset?"charset="+String(t.$cfg$.charset):"charset=utf8",u=i?"text/xml":r?"application/x-www-form-urlencoded":"text/plain",s={"Content-Type":u+"; "+$,"X-RT--Poll":"1","X-RT--Receive":"1","X-RT--mID":t.$mID$},c=null,a=null,p=null;t.$queue$.length&&(a=t.$queue$.slice(),i?(s["X-RT--Send"]="1",p=a.join("")):r?(s["X-RT--Send"]="x-rt--payload",s["X-RT--Message"]=c=e.UUID("------_rt_msg_","_------"),p="x-rt--payload="+l.Url.encode(a.join(c))):(s["X-RT--Send"]="1",s["X-RT--Message"]=c=e.UUID("------_rt_msg_","_------"),p=a.join(c))),t.$xhr$=o.create({url:t.$cfg$.endpoint+(-1<t.$cfg$.endpoint.indexOf("?")?"&":"?")+"__nocache__="+(new Date).getTime(),method:"POST",responseType:"text",headers:s,onError:function(e){t.$xhr$=null,t.emit("error",e.statusText)},onTimeout:function(e){t.$xhr$=null,t.$timer$=setTimeout(n,t.$cfg$.pollInterval)},onComplete:function(e){var r=e.getResponseHeader("X-RT--Message"),l=e.getResponseHeader("X-RT--mID"),o=e.getResponseHeader("X-RT--Close"),i=e.getResponseHeader("X-RT--Error");if(t.$xhr$=null,i)return t.emit("error",i);if(o)return t.close();if(l&&(t.$mID$=l),a&&t.$queue$.splice(0,a.length),r){var $,u,s=(e.responseText||"").split(r);for($=0,u=s.length;u>$;$++)t.emit("receive",s[$])}else e.responseText&&t.emit("receive",e.responseText);t.$timer$=setTimeout(n,t.$cfg$.pollInterval)}},p)};return t.$timer$=setTimeout(r,10),t.open()},e});