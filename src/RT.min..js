/**
*  RT
*  unified client-side real-time communication using (xhr) polling / bosh / (web)sockets for Node/JS
*
*  @version: 1.0.0
*  https://github.com/foo123/RT
*
**/
!function(e,t,n){"use strict";"object"==typeof exports?module.exports=n():(e[t]=n())&&"function"==typeof define&&define.amd&&define(function(){return e[t]})}(this,"RT",function(){"use strict";function e(t){t=t||{};var r=(t.use||t.rt_type||"default").toLowerCase();return e.Client.Impl[n](r)?new e.Client.Impl[r](t):new e.Client(t)}var t="prototype",n="hasOwnProperty",r=Object.keys,o=Object[t].toString,i="undefined"!=typeof global&&"[object global]"===o.call(global),a=String.fromCharCode,s=/^\s+|\s+$/g,u=String[t].trim?function(e){return e.trim()}:function(e){return e.replace(s,"")},l=/[^A-Za-z0-9\+\/\=]/g,c=/\x0d\x0a/g,d=i?null:window.XMLHttpRequest?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")},f=0;return e.VERSION="1.0.0",e.Platform={Node:i},e.XHR={create:function(t,r){if(t=t||{},i){if(!t.url)return null;var a="[object Object]"===o.call(t.url)?t.url:require("url").parse(t.url),s={method:t.method||"GET",agent:!1,protocol:a.protocol,host:a.hostname,hostname:a.hostname,port:a.port||80,path:(a.pathname||"/")+(a.query?"?"+a.query:"")},u="https:"===s.protocol?require("https").request:require("http").request,l={readyState:0,status:null,statusText:null,responseType:t.responseType||"text",responseURL:null,response:null,responseText:null,responseXml:null,headers:null,__headers__:null,send:function(e){null!=e&&(e=String(e),c.setHeader("Content-Length",e.length.toString()),c.write(e)),c.end()},abort:function(){c.abort()},getAllResponseHeaders:function(){return l.headers},getResponseHeader:function(e){if(null==e||4!==l.readyState)return null;var t=l.__headers__||{};return t[n](e)?t[e]:null},responseHeader:function(e){return l.getResponseHeader(e)},responseHeaders:function(e){return 4!==l.readyState?null:!0===e?l.__headers__:l.headers}},c=u(s,function(e){var n="",r=0;l.readyState=1,t.onStateChange&&t.onStateChange(l),l.headers=e.rawHeaders.join("\r\n"),l.__headers__=e.headers,l.responseURL=e.url||null,l.readyState=2,l.status=e.statusCode||null,l.statusText=e.statusMessage||null,t.onStateChange&&t.onStateChange(l),e.on("data",function(e){n+=e.toString(),r||(r=1,l.readyState=3,t.onStateChange&&t.onStateChange(l),t.onLoadStart&&t.onLoadStart(l)),t.onProgress&&t.onProgress(l)}),e.on("end",function(){l.readyState=4,l.responseType="text",l.response=l.responseText=n,t.onStateChange&&t.onStateChange(l),t.onLoadEnd&&t.onLoadEnd(l),4===l.readyState&&(200===l.status?t.onComplete&&t.onComplete(l):t.onRequestError?t.onRequestError(l):t.onError&&t.onError(l))}),e.on("error",function(e){l.statusText=e.toString(),t.onError&&t.onError(l)})});return c.setTimeout(t.timeout||3e4,function(e){t.onTimeout&&t.onTimeout(l)}),c.on("abort",function(e){t.onAbort&&t.onAbort(l)}),c.on("error",function(e){l.statusText=e.toString(),t.onError&&t.onError(l)}),t.headers&&e.Util.Header.encode(t.headers,null,c),c.setHeader("Connection","Keep-Alive"),arguments.length>1&&l.send(r),l}var l=d(),f=!0;return l._abort=l.abort,l._aborted=!1,l.abort=function(e){if(!l._aborted){!1===e&&(f=!1);try{l._abort()}catch(t){}l._aborted=!0,f=!0}},l.__headers__=null,l.responseHeader=function(e){return null==e||4!==l.readyState?null:l.getResponseHeader(e)},l.responseHeaders=function(t){if(4!==l.readyState)return null;var n=l.getAllResponseHeaders()||"";return null==l.__headers__&&(l.__headers__=e.Util.Header.decode(n)),!0===t?l.__headers__:n},t.url?(l.open(t.method||"GET",t.url,!t.sync),l.responseType=t.responseType||"text",t.headers&&e.Util.Header.encode(t.headers,l),t.mimeType&&l.overrideMimeType(t.mimeType),l.timeout=t.timeout||3e4,t.onProgress&&(l.onprogress=function(){t.onProgress(l)}),t.onLoadStart&&(l.onloadstart=function(){t.onLoadStart(l)}),t.onLoadEnd&&(l.onloadend=function(){t.onLoadEnd(l)}),!t.sync&&t.onStateChange&&(l.onreadystatechange=function(){t.onStateChange(l)}),l.onload=function(){4===l.readyState&&(200===l.status?t.onComplete&&t.onComplete(l):t.onRequestError?t.onRequestError(l):t.onError&&t.onError(l))},l.onabort=function(){f&&t.onAbort&&t.onAbort(l)},l.onerror=function(){t.onError&&t.onError(l)},l.ontimeout=function(){t.onTimeout&&t.onTimeout(l)},arguments.length>1&&l.send(r),l):l}},e.UUID=function(e,t){return(e||"")+ ++f+"_"+Date.now()+"_"+Math.floor(1e3*Math.random())+(t||"")},e.Const={BASE64:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",CRLF:"\r\n",CRLF_RE:/(\r\n)|\r|\n/g,COOKIE_RE:/([^=]+)(?:=(.*))?/},e.Util={String:{trim:u},Utf8:{encode:function(e){e=e.replace(c,"\n");var t,n,r,o="";for(t=0,n=e.length;n>t;t++)r=e.charCodeAt(t),o+=128>r?a(r):r>127&&2048>r?a(r>>6|192)+a(63&r|128):a(r>>12|224)+a(r>>6&63|128)+a(63&r|128);return o},decode:function(e){for(var t="",n=0,r=c1=c2=0,o=e.length;o>n;)r=e.charCodeAt(n),128>r?(t+=a(r),n++):r>191&&224>r?(c2=e.charCodeAt(n+1),t+=a((31&r)<<6|63&c2),n+=2):(c2=e.charCodeAt(n+1),c3=e.charCodeAt(n+2),t+=a((15&r)<<12|(63&c2)<<6|63&c3),n+=3);return t}},Base64:{encode:function(t){t=e.Util.Utf8.encode(t);for(var n,r,o,i,a,s,u,l="",c=0,d=t.length,f=e.Const.BASE64;d>c;)n=t.charCodeAt(c++),r=t.charCodeAt(c++),o=t.charCodeAt(c++),i=n>>2,a=(3&n)<<4|r>>4,s=(15&r)<<2|o>>6,u=63&o,isNaN(r)?s=u=64:isNaN(o)&&(u=64),l=l+f.charAt(i)+f.charAt(a)+f.charAt(s)+f.charAt(u);return l},decode:function(t){t=t.replace(l,"");for(var n,r,o,i,s,u,c,d="",f=0,h=t.length;h>f;)i=keyString.indexOf(t.charAt(f++)),s=keyString.indexOf(t.charAt(f++)),u=keyString.indexOf(t.charAt(f++)),c=keyString.indexOf(t.charAt(f++)),n=i<<2|s>>4,r=(15&s)<<4|u>>2,o=(3&u)<<6|c,d+=a(n),64!=u&&(d+=a(r)),64!=c&&(d+=a(o));return d=e.Util.Utf8.decode(d)}},Json:{encode:JSON.stringify,decode:JSON.parse},Url:{create:function(t){if(!t)return"";var n,i,a,s,u,l,c,d,f,h=[],p=r(t),g=p.length,C=e.Util.Url.encode;for(s=0,n=g>s?[[i=p[s++],t[i]]]:[];n.length;){if(u=n.shift(),i=u[0],a=u[1],f=o.call(a),"[object Array]"===f)for(i+="[]",l=0,c=a.length;c>l;l++)n.unshift([i,a[l]]);else if("[object Object]"===f)for(d=r(a),l=0,c=d.length;c>l;l++)n.unshift([i+"["+d[l]+"]",a[d[l]]]);else h.push(C(i)+"="+C(a));!n.length&&g>s&&n.unshift([i=p[s++],t[i]])}return h.join("&")},rawencode:function(e){return encodeURIComponent(""+e).split("!").join("%21").split("'").join("%27").split("(").join("%28").split(")").join("%29").split("*").join("%2A")},rawdecode:function(e){return decodeURIComponent(""+e)},encode:function(t){return e.Util.Url.rawencode(t).split("%20").join("+")},decode:function(t){return e.Util.Url.rawdecode((""+t).split("+").join("%20"))}},Cookie:{create:function(e,t,n,r,o,i,a){var s=arguments.length;return{name:s>0?e:"",value:s>1?t:"",domain:s>2?n:"",path:s>3?r:"/",expires:s>4?o:new Date(Date.now()+31536e6),secure:s>5?!!i:!1,httponly:s>6?!!a:!1}},encode:function(e){if(e&&e.name){var t=String(e.name)+"="+String(e.value);return t+="; Domain="+String(e.domain),t+="; Path="+String(e.path),t+="; Expires="+String(e.expires),e.secure&&(t+="; Secure"),e.httponly&&(t+="; HttpOnly"),t}},decode:function(t){var r,o,i,a,s=e.Util.Cookie.create(),u=e.Const.COOKIE_RE,l=String(t).split("; ");if(null!=(r=l.shift().match(u))){for(s.name=r[1],s.value=r[2],i=0,a=l.length;a>i;i++)r=l[i].match(u),null!=r&&r.length&&(o=r[1].toLowerCase(),s[n](o)&&(s[o]="string"==typeof r[2]?r[2]:!0));return"string"==typeof s.expires&&(s.expires=new Date(s.expires)),s}}},Header:{encode:function(t,n,i){var a="";if(!t)return xhr?xhr:a;var s,u,l,c,d,f=r(t),h=e.Const.CRLF;if(i){for(u=0,l=f.length;l>u;u++)s=f[u],i.setHeader(s,t[s]);return i}if(n){for(u=0,l=f.length;l>u;u++)if(s=f[u],"[object Array]"===o.call(t[s]))for(c=0,d=t[s].length;d>c;c++)n.setRequestHeader(s,t[s][c]);else n.setRequestHeader(s,t[s]);return n}for(u=0,l=f.length;l>u;u++)if(s=f[u],"[object Array]"===o.call(t[s]))for(c=0,d=t[s].length;d>c;c++)a+=h+String(t[s][c]);else a.length&&(a+=h),a+=s+": "+String(t[s]);return a},decode:function(t,r){var o,i,a,s,l={},c=null,d=e.Const.CRLF;if(t)for(r=!0===r,t=t.split(d),i=0,a=t.length;a>i;i++)s=t[i],o=s.split(":"),o.length>1?(c=u(o.shift()),r&&(c=c.toLowerCase()),l[n](c)?("string"==typeof l[c]&&(l[c]=[l[c]]),l[c].push(u(o.join(":")))):l[c]=u(o.join(":"))):o[0].length&&c&&(l[c]=d+o[0]);return l}}},e.Client=function h(t){var n=this;return n instanceof h?(n.$cfg$=t||{},n.$event$={},void(n.status=e.Client.CREATED)):new h(t)},e.Client.Impl={},e.Client.CREATED=1,e.Client.DESTROYED=0,e.Client.OPENED=2,e.Client.CLOSED=4,e.Client.PENDING=8,e.Client.ABORTED=16,e.Client[t]={constructor:e.Client,status:e.Client.CREATED,$cfg$:null,$event$:null,dispose:function(){var t=this;return t.status=e.Client.DESTROYED,t.$cfg$=null,t.$event$=null,t},config:function(e,t){var n=this,r=n.$cfg$;return e?arguments.length>1?(r[e]=t,n):r[e]:void 0},on:function(e,t,r){var o=this;return e&&t?(o.$event$[n](e)?o.$event$[e].push([t,!0===r,0]):o.$event$[e]=[[t,!0===r,0]],o):o},one:function(e,t){return this.on(e,t,!0)},off:function(e,t){var r=this;if(!e||!r.$event$[n](e))return r;if(null==t)delete r.$event$[e];else{for(var o=r.$event$[e],i=o.length-1;i>=0;i--)o[i][0]===t&&t.splice(i,1);o.length||delete r.$event$[e]}return r},emit:function(e,t){var r=this;if(!e||!r.$event$[n](e))return r;var o,i,a=r.$event$[e].slice(),s=a.length,u=[],l={event:e,data:t,target:r};for(o=0;s>o;o++)i=a[o],i[1]&&u.push(o),i[1]&&i[2]||(i[2]=1,i[0](l));for(a=r.$event$[e],o=u.length-1;o>=0;o--)a.splice(u[o],1);return a.length||delete r.$event$[e],r},abort:function(t,n){return this.status=e.Client.ABORTED,!0===t?this.emit("abort",n):this},open:function(t){return this.status=e.Client.OPENED,this.emit("open",t)},close:function(t){return this.status=e.Client.CLOSED,this.emit("close",t)},send:function(e){return this},listen:function(){return this},init:function(){var e=this;return setTimeout(function(){e.listen()},40),e}},e.Client[t].addEventListener=e.Client[t].on,e.Client[t].removeEventListener=e.Client[t].off,e.Client[t].trigger=e.Client[t].dispatchEvent=e.Client[t].emit,e});