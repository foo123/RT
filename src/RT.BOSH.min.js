/**
*  RT
*  unified client-side real-time communication using (xhr) polling / bosh / (web)sockets
*  RT BOSH Client
*
*  @version: 0.1.0
*  https://github.com/foo123/RT
*
**/
!function(e,t){"use strict";"object"==typeof exports?t(require("./RT.js")):t(e.RT)&&"function"==typeof define&&define.amd&&define(function(){return e.RT})}(this,function(e){"use strict";var t="prototype",n=(Object[t].toString,e.Client[t]),r=e.Util,o=e.XHR;return e.Client.BOSH=function i(e){var t=this;return t instanceof i?(n.constructor.call(t,e),t.$cfg$.timeout=t.$cfg$.timeout||1e3,t.$send$=null,t.$recv$=null,void(t.$mID$=0)):new i(e)},e.Client.Impl.bosh=e.Client.Impl["long-poll"]=e.Client.BOSH,e.Client.BOSH[t]=Object.create(n),e.Client.BOSH[t].constructor=e.Client.BOSH,e.Client.BOSH[t].$send$=null,e.Client.BOSH[t].$recv$=null,e.Client.BOSH[t].$mID$=null,e.Client.BOSH[t].dispose=function(){var e=this;return e.abort(),e.$mID$=null,n.dispose.call(e)},e.Client.BOSH[t].abort=function(e){var t=this;return t.$recv$&&(t.$recv$.abort(!0===e),t.$recv$=null),t.$send$=null,t},e.Client.BOSH[t].send=function(e){var t=this;return o.create({url:t.$cfg$.url+(-1<t.$cfg$.url.indexOf("?")?"&":"?")+"__nocache__="+(new Date).getTime(),method:"POST",responseType:"text",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf8","X-RT--BOSH":"1","X-RT--Send":"1"},onError:function(e){t.emit("error",e.statusText)},onComplete:function(e){var n=e.responseHeader("X-RT--Close"),r=e.responseHeader("X-RT--Error");return r?void t.emit("error",r):n?void t.close():void 0}},"rt_payload="+r.Url.encode(String(e))),t},e.Client.BOSH[t].listen=function(){var e=this,t=function n(){e.$recv$=o.create({url:e.$cfg$.url+(-1<e.$cfg$.url.indexOf("?")?"&":"?")+"__nocache__="+(new Date).getTime(),timeout:e.$cfg$.timeout,method:"POST",responseType:"text",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf8","X-RT--BOSH":"1","X-RT--Receive":"1","X-RT--mID":e.$mID$},onError:function(t){e.emit("error",t.statusText),e.$recv$=null},onTimeout:function(){setTimeout(n,0)},onComplete:function(t){var r=t.responseHeader("X-RT--Message"),o=t.responseHeader("X-RT--Close"),i=t.responseHeader("X-RT--Error"),l=t.responseHeader("X-RT--mID");if(i)return void e.emit("error",i);if(o)return void e.close();if(r){var s,u,c=(t.responseText||"").split(r);for(s=0,u=c.length;u>s;s++)e.emit("receive",c[s])}l&&(e.$mID$=l),setTimeout(n,0)}},null)};return setTimeout(t,0),e.emit("open")},e});