/**
*  RT
*  unified client-side real-time communication using (xhr) polling / bosh / (web)sockets / webrtc for Node/XPCOM/JS
*  RT BOSH Client
*
*  @version: 1.0.1
*  https://github.com/foo123/RT
*
**/
!function(e,n){"use strict";"object"==typeof module&&module.exports?module.exports=n.call(e,module.$deps&&module.$deps.RT||require("./RT")):"function"==typeof define&&define.amd&&"function"==typeof require&&"function"==typeof require.specified&&require.specified("RT_BOSH")?define("RT_BOSH",["module","RT"],function(t,$){return n.moduleUri=t.uri,n.call(e,$),$}):(n.call(e,e.RT)||1)&&"function"==typeof define&&define.amd&&define(function(){return e.RT})}(this,function(e){"use strict";var n="prototype",t=(Object[n].toString,e.Client),$=t[n],r=e.Util,o=e.XHR,i=t.BOSH=function s(e){var n=this;return n instanceof s?($.constructor.call(n,e),n.$cfg$.timeout=n.$cfg$.timeout||5e3,n.$send$=null,n.$recv$=null,n.$queue$=[],void(n.$mID$=0)):new s(e)};return t.Impl.bosh=t.Impl["long-poll"]=i,i[n]=Object.create($),i[n].constructor=i,i[n].$send$=null,i[n].$recv$=null,i[n].$queue$=null,i[n].$mID$=null,i[n].dispose=function(){var e=this;return e.$recv$&&(e.$recv$.abort().dispose(),e.$recv$=null),e.$send$&&(e.$send$.abort().dispose(),e.$send$=null),e.$queue$=null,e.$mID$=null,$.dispose.call(e)},i[n].abort=function(e){var n=this;return n.$recv$&&(n.$recv$.abort().dispose(),n.$recv$=null),n.$send$&&(n.$send$.abort().dispose(),n.$send$=null),$.abort.call(n,!0===e)},i[n].send=function(n){var t=this,$=function i(){var n="urlencoded"===t.$cfg$.contentType,$="xml"===t.$cfg$.contentType,s=t.$cfg$.charset?"charset="+String(t.$cfg$.charset):"charset=utf8",c=$?"text/xml":n?"application/x-www-form-urlencoded":"text/plain",u={Connection:"Keep-Alive","Content-Type":c+"; "+s,"X-RT--BOSH":"1","X-RT--Receive":"1","X-RT--mID":t.$mID$},l=t.$queue$.slice(),d=null,f=null;$?(u["X-RT--Send"]="1",f=l.join("")):n?(u["X-RT--Send"]="x-rt--payload",u["X-RT--Message"]=d=e.UUID("------_rt_msg_","_------"),f="x-rt--payload="+r.Url.encode(l.join(d))):(u["X-RT--Send"]="1",u["X-RT--Message"]=d=e.UUID("------_rt_msg_","_------"),f=l.join(d)),t.$send$=o.create({url:t.$cfg$.endpoint+(-1<t.$cfg$.endpoint.indexOf("?")?"&":"?")+"__nocache__="+(new Date).getTime(),timeout:t.$cfg$.timeout,method:"POST",responseType:"text",headers:u,onError:function(e){t.$send$=null,e===t.$recv$&&(t.$recv$=null),t.emit("error",e.statusText)},onTimeout:function(e){t.$send$=null,e===t.$recv$&&(t.$recv$=null),t.$queue$.length?setTimeout(i,100):t.$recv$||setTimeout(function(){t.$receive$()},100)},onComplete:function(e){var n=e.getResponseHeader("X-RT--Message"),$=e.getResponseHeader("X-RT--mID"),r=e.getResponseHeader("X-RT--Close"),o=e.getResponseHeader("X-RT--Error");if(t.$send$=null,e===t.$recv$&&(t.$recv$=null),o)return t.emit("error",o);if(r)return t.close();if($&&(t.$mID$=$),t.$queue$.splice(0,l.length),n){var s,c,u=(e.responseText||"").split(n);for(s=0,c=u.length;c>s;s++)t.emit("receive",u[s])}else e.responseText&&t.emit("receive",e.responseText);t.$queue$.length?setTimeout(i,100):t.$recv$||setTimeout(function(){t.$receive$()},100)}},f)};return t.$queue$.push(String(n)),t.$send$||setTimeout($,0),t},i[n].$receive$=function(){var e=this;if(!e.$recv$){var n="urlencoded"===e.$cfg$.contentType,t="xml"===e.$cfg$.contentType,$=e.$cfg$.charset?"charset="+String(e.$cfg$.charset):"charset=utf8",r=t?"text/xml":n?"application/x-www-form-urlencoded":"text/plain",i={Connection:"Keep-Alive","Content-Type":r+"; "+$,"X-RT--BOSH":"1","X-RT--Receive":"1","X-RT--mID":e.$mID$};e.$recv$=o.create({url:e.$cfg$.endpoint+(-1<e.$cfg$.endpoint.indexOf("?")?"&":"?")+"__nocache__="+(new Date).getTime(),timeout:e.$cfg$.timeout,method:"POST",responseType:"text",headers:i,onError:function(n){e.$send$?(e.$recv$=e.$send$,e.$send$=null):e.$recv$=null,e.emit("error",n.statusText)},onTimeout:function(n){e.$send$?(e.$recv$=e.$send$,e.$send$=null):e.$recv$=null,e.$recv$||setTimeout(function(){e.$receive$()},100)},onComplete:function(n){var t=n.getResponseHeader("X-RT--Message"),$=n.getResponseHeader("X-RT--mID"),r=n.getResponseHeader("X-RT--Close"),o=n.getResponseHeader("X-RT--Error");if(e.$send$?(e.$recv$=e.$send$,e.$send$=null):e.$recv$=null,o)return e.emit("error",o);if(r)return e.close();if($&&(e.$mID$=$),t){var i,s,c=(n.responseText||"").split(t);for(i=0,s=c.length;s>i;i++)e.emit("receive",c[i])}else n.responseText&&e.emit("receive",n.responseText);e.$recv$||setTimeout(function(){e.$receive$()},100)}},null)}},i[n].listen=function(){var e=this;return setTimeout(function(){e.$receive$()},10),e.open()},e});