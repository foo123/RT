/**
*  RT
*  unified client-side real-time communication using (xhr) polling / bosh / (web)sockets for Node/JS
*  RT BOSH Client
*
*  @version: 1.0.0
*  https://github.com/foo123/RT
*
**/
!function(e,t){"use strict";"object"==typeof exports?t(require("./RT.js")):t(e.RT)&&"function"==typeof define&&define.amd&&define(function(){return e.RT})}(this,function(e){"use strict";var t="prototype",n=(Object[t].toString,e.Client[t]),r=e.Util,o=e.XHR;return e.Client.BOSH=function i(e){var t=this;return t instanceof i?(n.constructor.call(t,e),t.$cfg$.timeout=t.$cfg$.timeout||5e3,t.$send$=null,t.$recv$=null,t.$queue$=[],void(t.$mID$=0)):new i(e)},e.Client.Impl.bosh=e.Client.Impl["long-poll"]=e.Client.BOSH,e.Client.BOSH[t]=Object.create(n),e.Client.BOSH[t].constructor=e.Client.BOSH,e.Client.BOSH[t].$send$=null,e.Client.BOSH[t].$recv$=null,e.Client.BOSH[t].$queue$=null,e.Client.BOSH[t].$mID$=null,e.Client.BOSH[t].dispose=function(){var e=this;return e.$recv$&&(e.$recv$.abort(),e.$recv$=null),e.$send$&&(e.$send$.abort(),e.$send$=null),e.$queue$=null,e.$mID$=null,n.dispose.call(e)},e.Client.BOSH[t].abort=function(e){var t=this;return t.$recv$&&(t.$recv$.abort(),t.$recv$=null),t.$send$&&(t.$send$.abort(),t.$send$=null),n.abort.call(t,!0===e)},e.Client.BOSH[t].send=function(t){var n=this,i=function $(){var t=n.$queue$.slice(),i=e.UUID("--------_rt_msg_","_--------");n.$send$=o.create({url:n.$cfg$.endpoint+(-1<n.$cfg$.endpoint.indexOf("?")?"&":"?")+"__nocache__="+(new Date).getTime(),method:"POST",responseType:"text",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf8","X-RT--BOSH":"1","X-RT--Send":"x-rt--payload","X-RT--Message":i},onError:function(e){n.$send$=null,n.emit("error",e.statusText)},onTimeout:function(e){n.$send$=null,n.$queue$.length&&setTimeout($,100)},onComplete:function(e){return n.$send$=null,e.getResponseHeader("X-RT--Error")?n.emit("error",rt_error):(n.$queue$.splice(0,t.length),void(n.$queue$.length&&setTimeout($,10)))}},"x-rt--payload="+r.Url.encode(t.join(i)))};return n.$queue$.push(String(t)),n.$send$||setTimeout(i,0),n},e.Client.BOSH[t].listen=function(){var e=this,t=function n(){e.$recv$=o.create({url:e.$cfg$.endpoint+(-1<e.$cfg$.endpoint.indexOf("?")?"&":"?")+"__nocache__="+(new Date).getTime(),timeout:e.$cfg$.timeout,method:"POST",responseType:"text",headers:{Connection:"Keep-Alive","Content-Type":"application/x-www-form-urlencoded; charset=utf8","X-RT--BOSH":"1","X-RT--Receive":"1","X-RT--mID":e.$mID$},onError:function(t){e.$recv$=null,e.emit("error",t.statusText)},onTimeout:function(t){e.$recv$=null,setTimeout(n,10)},onComplete:function(t){var r=t.getResponseHeader("X-RT--Message"),o=t.getResponseHeader("X-RT--mID"),i=t.getResponseHeader("X-RT--Close"),$=t.getResponseHeader("X-RT--Error");if(e.$recv$=null,$)return e.emit("error",$);if(i)return e.close();if(o&&(e.$mID$=o),r){var l,u,s=(t.responseText||"").split(r);for(l=0,u=s.length;u>l;l++)e.emit("receive",s[l])}else t.responseText&&e.emit("receive",t.responseText);setTimeout(n,10)}},null)};return setTimeout(t,10),e.open()},e});