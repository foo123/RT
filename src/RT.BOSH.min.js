/**
*  RT
*  unified client-side real-time communication using (xhr) polling / bosh / (web)sockets for Node/JS
*  RT BOSH Client
*
*  @version: 1.0.0
*  https://github.com/foo123/RT
*
**/
!function(e,t){"use strict";"object"==typeof exports?t(require("./RT.js")):t(e.RT)&&"function"==typeof define&&define.amd&&define(function(){return e.RT})}(this,function(e){"use strict";var t="prototype",n=(Object[t].toString,e.Client[t]),o=e.Util,i=e.XHR;return e.Client.BOSH=function l(e){var t=this;return t instanceof l?(n.constructor.call(t,e),t.$cfg$.timeout=t.$cfg$.timeout||1e3,t.$bosh$=null,t.$queue$=[],void(t.$mID$=0)):new l(e)},e.Client.Impl.bosh=e.Client.Impl["long-poll"]=e.Client.BOSH,e.Client.BOSH[t]=Object.create(n),e.Client.BOSH[t].constructor=e.Client.BOSH,e.Client.BOSH[t].$bosh$=null,e.Client.BOSH[t].$queue$=null,e.Client.BOSH[t].$mID$=null,e.Client.BOSH[t].dispose=function(){var e=this;return e.$bosh$&&(e.$bosh$.abort(),e.$bosh$=null),e.$queue$=null,e.$mID$=null,n.dispose.call(e)},e.Client.BOSH[t].abort=function(e){var t=this;return t.$bosh$&&(t.$bosh$.abort(),t.$bosh$=null),n.abort.call(t,!0===e)},e.Client.BOSH[t].send=function(e){var t=this;return t.$queue$.push(String(e)),t},e.Client.BOSH[t].listen=function(){var t=this,n=function l(){var n={Connection:"Keep-Alive","Content-Type":"application/x-www-form-urlencoded; charset=utf8","X-RT--BOSH":"1","X-RT--Receive":"1","X-RT--mID":t.$mID$},r=null,s=null;t.$queue$.length&&(n["X-RT--Send"]="x-rt--payload",n["X-RT--Message"]=r=e.UUID("--------_rt_msg_","_--------"),s=t.$queue$.slice()),t.$bosh$=i.create({url:t.$cfg$.endpoint+(-1<t.$cfg$.endpoint.indexOf("?")?"&":"?")+"__nocache__="+(new Date).getTime(),timeout:t.$cfg$.timeout,method:"POST",responseType:"text",headers:n,onError:function(e){t.$bosh$=null,t.emit("error",e.statusText)},onTimeout:function(e){t.$bosh$=null,setTimeout(l,0)},onComplete:function(e){var n=e.getResponseHeader("X-RT--Message"),o=e.getResponseHeader("X-RT--Close"),i=e.getResponseHeader("X-RT--Error"),r=e.getResponseHeader("X-RT--mID");if(i)return t.$bosh$=null,t.emit("error",i);if(o)return t.$bosh$=null,t.close();if(r&&(t.$mID$=r),s&&t.$queue$.splice(0,s.length),n){var u,$,c=(e.responseText||"").split(n);for(u=0,$=c.length;$>u;u++)t.emit("receive",c[u])}else e.responseText&&t.emit("receive",e.responseText);t.$bosh$=null,setTimeout(l,0)}},s?"x-rt--payload="+o.Url.encode(s.join(r)):null)};return setTimeout(n,0),t.open()},e});