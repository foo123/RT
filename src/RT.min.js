/**
*  RT
*  unified client-side real-time communication using (xhr) polling / bosh / (web)sockets / webrtc for Node/XPCOM/JS
*
*  @version: 1.0.1
*  https://github.com/foo123/RT
*
**/
!function(e,t,n){"use strict";"undefined"!=typeof Components&&"object"==typeof Components.classes&&"object"==typeof Components.classesByID&&Components.utils&&"function"==typeof Components.utils["import"]?(e.$deps=e.$deps||{})&&(e.EXPORTED_SYMBOLS=[t])&&(e[t]=e.$deps[t]=n.call(e)):"object"==typeof module&&module.exports?(module.$deps=module.$deps||{})&&(module.exports=module.$deps[t]=n.call(e)):"function"==typeof define&&define.amd&&"function"==typeof require&&"function"==typeof require.specified&&require.specified(t)?define(t,["module"],function(t){return n.moduleUri=t.uri,n.call(e)}):t in e||(e[t]=n.call(e)||1)&&"function"==typeof define&&define.amd&&define(function(){return e[t]})}(this,"RT",function(){"use strict";function e(t){t=t||{};var n=(t.use||t.rt_type||"default").toLowerCase();return e.Client.Impl[o](n)?new e.Client.Impl[n](t):new e.Client(t)}var t,n,r="prototype",o="hasOwnProperty",s=Object.keys,i=Object[r].toString,a="undefined"!=typeof Components&&"object"==typeof Components.classes&&"object"==typeof Components.classesByID&&Components.utils&&"function"==typeof Components.utils["import"],u="undefined"!=typeof global&&"[object global]"===i.call(global),l=!a&&!u&&"undefined"!=typeof WorkerGlobalScope&&"function"==typeof importScripts&&navigator instanceof WorkerNavigator,d=!a&&!u&&!l&&"undefined"!=typeof navigator,c=String.fromCharCode,p=/^\s+|\s+$/g,f=String[r].trim?function(e){return e.trim()}:function(e){return e.replace(p,"")},h=/[^A-Za-z0-9\+\/\=]/g,g=/\x0d\x0a/g,m=0;return e.VERSION="1.0.1",e.Platform={XPCOM:a,Node:u,WebWorker:l,Browser:d},t=e.XHR=function C(e,t){var n=this,r=!1;n.readyState=C.UNSENT,n.status=null,n.statusText=null,n.responseType="text",n.responseURL=null,n.response=null,n.responseText=null,n.responseXml=null,n._rawHeaders=null,n._headers=null,n.send=function(t){return r||C.UNSENT!==n.readyState?n:(e&&e(t),n.readyState=C.OPENED,n)},n.abort=function(){return r?n:(r=!0,t&&t(),n)},n.getAllResponseHeaders=function(e){return C.DONE!==n.readyState?null:!0===e?n._headers:n._rawHeaders},n.getResponseHeader=function(e,t){if(null==e||C.DONE!==n.readyState)return null;var r=n._headers||{};return!1!==t&&(e=e.toLowerCase()),r[o](e)?r[e]:null},n.dispose=function(){return n.readyState=null,n.status=null,n.statusText=null,n.responseType=null,n.responseURL=null,n.response=null,n.responseText=null,n.responseXml=null,n._rawHeaders=null,n._headers=null,n.getAllResponseHeaders=null,n.getResponseHeader=null,n.send=null,n.abort=null,n}},t.UNSENT=0,t.OPENED=1,t.HEADERS_RECEIVED=2,t.LOADING=3,t.DONE=4,t.create=a?function(r,o){if(r=r||{},!r.url)return null;var s=Components.classes["@mozilla.org/xmlextras/xmlhttprequest;1"].createInstance(),i=new t(function(e){s.send(e)},function(){s.abort()}),a=function(e,t){return e.readyState=t.readyState,e.responseType=t.responseType,e.responseURL=t.responseURL,e.response=t.response,e.responseText=t.responseText,e.responseXml=t.responseXml,e.status=t.status,e.statusText=t.statusText,e};return i.getAllResponseHeaders=function(e){var t=s.getAllResponseHeaders();return!0===e?n.Header.decode(t):t},i.getResponseHeader=function(e){return s.getResponseHeader(e)},s.open(r.method||"GET",r.url,!r.sync),i.responseType=s.responseType=r.responseType||"text",s.timeout=r.timeout||3e4,r.onProgress&&s.addEventListener("progress",function(){r.onProgress(a(i,s))}),r.onLoadStart&&s.addEventListener("loadstart",function(){r.onLoadStart(a(i,s))}),!r.sync&&r.onStateChange&&s.addEventListener("readystatechange",function(){r.onStateChange(a(i,s))}),s.addEventListener("load",function(){a(i,s),e.XHR.DONE===s.readyState&&(200===s.status?r.onComplete&&r.onComplete(i):r.onRequestError?r.onRequestError(i):r.onError&&r.onError(i))}),s.addEventListener("abort",function(){r.onAbort&&r.onAbort(a(i,s))}),s.addEventListener("error",function(){r.onError&&r.onError(a(i,s))}),s.addEventListener("timeout",function(){r.onTimeout&&r.onTimeout(a(i,s))}),r.headers&&n.Header.encode(r.headers,s),r.mimeType&&s.overrideMimeType(r.mimeType),arguments.length>1&&i.send(o),i}:u?function(r,o){if(r=r||{},!r.url)return null;var s,a,u="[object Object]"===i.call(r.url)?r.url:require("url").parse(r.url),l={method:r.method||"GET",agent:!1,protocol:u.protocol,host:u.hostname,hostname:u.hostname,port:u.port||80,path:(u.pathname||"/")+(u.query?"?"+u.query:"")};return a=new t(function(e){null!=e&&(e=String(e),s.setHeader("Content-Length",String(e.length)),s.write(e)),s.end()},function(){s.abort()}),s=("https:"===l.protocol?require("https").request:require("http").request)(l,function(t){var n="",o=0;a.readyState=e.XHR.OPENED,r.onStateChange&&r.onStateChange(a),a.readyState=e.XHR.HEADERS_RECEIVED,a._rawHeaders=t.rawHeaders.join("\r\n"),a._headers=t.headers,a.responseURL=t.url||null,a.status=t.statusCode||null,a.statusText=t.statusMessage||null,r.onStateChange&&r.onStateChange(a),t.on("data",function(t){n+=t.toString(),o||(o=1,a.readyState=e.XHR.LOADING,r.onStateChange&&r.onStateChange(a),r.onLoadStart&&r.onLoadStart(a)),r.onProgress&&r.onProgress(a)}),t.on("end",function(){a.readyState=e.XHR.DONE,a.responseType="text",a.response=a.responseText=n,r.onStateChange&&r.onStateChange(a),r.onLoadEnd&&r.onLoadEnd(a),e.XHR.DONE===a.readyState&&(200===a.status?r.onComplete&&r.onComplete(a):r.onRequestError?r.onRequestError(a):r.onError&&r.onError(a))}),t.on("error",function(e){a.statusText=e.toString(),r.onError&&r.onError(a)})}),s.setTimeout(r.timeout||3e4,function(e){r.onTimeout&&r.onTimeout(a)}),s.on("abort",function(e){r.onAbort&&r.onAbort(a)}),s.on("error",function(e){a.statusText=e.toString(),r.onError&&r.onError(a)}),r.headers&&n.Header.encode(r.headers,null,s),arguments.length>1&&a.send(o),a}:function(r,o){if(r=r||{},!r.url)return null;var s="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),i=new t(function(e){s.send(e)},function(){s.abort()}),a=function(e,t){return e.readyState=t.readyState,e.responseType=t.responseType,e.responseURL=t.responseURL,e.response=t.response,e.responseText=t.responseText,e.responseXml=t.responseXml,e.status=t.status,e.statusText=t.statusText,e};return i.getAllResponseHeaders=function(e){var t=s.getAllResponseHeaders();return!0===e?n.Header.decode(t):t},i.getResponseHeader=function(e){return s.getResponseHeader(e)},s.open(r.method||"GET",r.url,!r.sync),i.responseType=s.responseType=r.responseType||"text",s.timeout=r.timeout||3e4,r.onProgress&&(s.onprogress=function(){r.onProgress(a(i,s))}),r.onLoadStart&&(s.onloadstart=function(){r.onLoadStart(a(i,s))}),r.onLoadEnd&&(s.onloadend=function(){r.onLoadEnd(a(i,s))}),!r.sync&&r.onStateChange&&(s.onreadystatechange=function(){r.onStateChange(a(i,s))}),s.onload=function(){a(i,s),e.XHR.DONE===s.readyState&&(200===s.status?r.onComplete&&r.onComplete(i):r.onRequestError?r.onRequestError(i):r.onError&&r.onError(i))},s.onabort=function(){r.onAbort&&r.onAbort(a(i,s))},s.onerror=function(){r.onError&&r.onError(a(i,s))},s.ontimeout=function(){r.onTimeout&&r.onTimeout(a(i,s))},r.headers&&n.Header.encode(r.headers,s),r.mimeType&&s.overrideMimeType(r.mimeType),arguments.length>1&&i.send(o),i},e.UUID=function(e,t){return(e||"")+ ++m+"_"+Date.now()+"_"+Math.floor(1e3*Math.random())+(t||"")},e.Const={BASE64:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",CRLF:"\r\n",CRLF_RE:/(\r\n)|\r|\n/g,COOKIE_RE:/([^=]+)(?:=(.*))?/},n=e.Util={String:{trim:f},Utf8:{encode:function(e){e=e.replace(g,"\n");var t,n,r,o="";for(t=0,n=e.length;n>t;t++)r=e.charCodeAt(t),o+=128>r?c(r):r>127&&2048>r?c(r>>6|192)+c(63&r|128):c(r>>12|224)+c(r>>6&63|128)+c(63&r|128);return o},decode:function(e){for(var t="",n=0,r=c1=c2=0,o=e.length;o>n;)r=e.charCodeAt(n),128>r?(t+=c(r),n++):r>191&&224>r?(c2=e.charCodeAt(n+1),t+=c((31&r)<<6|63&c2),n+=2):(c2=e.charCodeAt(n+1),c3=e.charCodeAt(n+2),t+=c((15&r)<<12|(63&c2)<<6|63&c3),n+=3);return t}},Base64:{encode:function(t){t=n.Utf8.encode(t);for(var r,o,s,i,a,u,l,d="",c=0,p=t.length,f=e.Const.BASE64;p>c;)r=t.charCodeAt(c++),o=t.charCodeAt(c++),s=t.charCodeAt(c++),i=r>>2,a=(3&r)<<4|o>>4,u=(15&o)<<2|s>>6,l=63&s,isNaN(o)?u=l=64:isNaN(s)&&(l=64),d=d+f.charAt(i)+f.charAt(a)+f.charAt(u)+f.charAt(l);return d},decode:function(e){e=e.replace(h,"");for(var t,r,o,s,i,a,u,l="",d=0,p=e.length;p>d;)s=keyString.indexOf(e.charAt(d++)),i=keyString.indexOf(e.charAt(d++)),a=keyString.indexOf(e.charAt(d++)),u=keyString.indexOf(e.charAt(d++)),t=s<<2|i>>4,r=(15&i)<<4|a>>2,o=(3&a)<<6|u,l+=c(t),64!=a&&(l+=c(r)),64!=u&&(l+=c(o));return l=n.Utf8.decode(l)}},Json:{encode:JSON.stringify,decode:JSON.parse},Url:{create:function(e){if(!e)return"";var t,r,o,a,u,l,d,c,p,f=[],h=s(e),g=h.length,m=n.Url.encode;for(a=0,t=g>a?[[r=h[a++],e[r]]]:[];t.length;){if(u=t.shift(),r=u[0],o=u[1],p=i.call(o),"[object Array]"===p)for(r+="[]",l=0,d=o.length;d>l;l++)t.unshift([r,o[l]]);else if("[object Object]"===p)for(c=s(o),l=0,d=c.length;d>l;l++)t.unshift([r+"["+c[l]+"]",o[c[l]]]);else f.push(m(r)+"="+m(o));!t.length&&g>a&&t.unshift([r=h[a++],e[r]])}return f.join("&")},rawencode:function(e){return encodeURIComponent(""+e).split("!").join("%21").split("'").join("%27").split("(").join("%28").split(")").join("%29").split("*").join("%2A")},rawdecode:function(e){return decodeURIComponent(""+e)},encode:function(e){return n.Url.rawencode(e).split("%20").join("+")},decode:function(e){return n.Url.rawdecode((""+e).split("+").join("%20"))}},Cookie:{create:function(e,t,n,r,o,s,i){var a=arguments.length;return{name:a>0?e:"",value:a>1?t:"",domain:a>2?n:"",path:a>3?r:"/",expires:a>4?o:new Date(Date.now()+31536e6),secure:a>5?!!s:!1,httponly:a>6?!!i:!1}},encode:function(e){if(e&&e.name){var t=String(e.name)+"="+String(e.value);return t+="; Domain="+String(e.domain),t+="; Path="+String(e.path),t+="; Expires="+String(e.expires),e.secure&&(t+="; Secure"),e.httponly&&(t+="; HttpOnly"),t}},decode:function(t){var r,s,i,a,u=n.Cookie.create(),l=e.Const.COOKIE_RE,d=String(t).split("; ");if(null!=(r=d.shift().match(l))){for(u.name=r[1],u.value=r[2],i=0,a=d.length;a>i;i++)r=d[i].match(l),null!=r&&r.length&&(s=r[1].toLowerCase(),u[o](s)&&(u[s]="string"==typeof r[2]?r[2]:!0));return"string"==typeof u.expires&&(u.expires=new Date(u.expires)),u}}},Header:{encode:function(t,n,r){var o="";if(!t)return xhr?xhr:o;var a,u,l,d,c,p=s(t),f=e.Const.CRLF;if(r){for(u=0,l=p.length;l>u;u++)a=p[u],r.setHeader(a,t[a]);return r}if(n){for(u=0,l=p.length;l>u;u++)if(a=p[u],"[object Array]"===i.call(t[a]))for(d=0,c=t[a].length;c>d;d++)n.setRequestHeader(a,String(t[a][d]));else n.setRequestHeader(a,String(t[a]));return n}for(u=0,l=p.length;l>u;u++)if(a=p[u],"[object Array]"===i.call(t[a]))for(o.length&&(o+=f),o+=a+": "+String(t[a][0]),d=1,c=t[a].length;c>d;d++)o+=f+String(t[a][d]);else o.length&&(o+=f),o+=a+": "+String(t[a]);return o},decode:function(t,n){var r,s,i,a,u={},l=null,d=e.Const.CRLF;if(t)for(n=!0===n,t=t.split(d),s=0,i=t.length;i>s;s++)a=t[s],r=a.split(":"),r.length>1?(l=f(r.shift()),n&&(l=l.toLowerCase()),u[o](l)?("string"==typeof u[l]&&(u[l]=[u[l]]),u[l].push(f(r.join(":")))):u[l]=f(r.join(":"))):r[0].length&&l&&(u[l]=d+r[0]);return u}}},e.Client=function E(t){var n=this;return n instanceof E?(n.$cfg$=t||{},n.$event$={},void(n.status=e.Client.CREATED)):new E(t)},e.Client.Impl={},e.Client.CREATED=1,e.Client.DESTROYED=0,e.Client.OPENED=2,e.Client.CLOSED=4,e.Client.PENDING=8,e.Client.ABORTED=16,e.Client[r]={constructor:e.Client,status:e.Client.CREATED,$cfg$:null,$event$:null,dispose:function(){var t=this;return t.status=e.Client.DESTROYED,t.$cfg$=null,t.$event$=null,t},config:function(e,t){var n=this,r=n.$cfg$;return e?arguments.length>1?(r[e]=t,n):r[e]:void 0},on:function(e,t,n){var r=this;return e&&t?(r.$event$[o](e)?r.$event$[e].push([t,!0===n,0]):r.$event$[e]=[[t,!0===n,0]],r):r},one:function(e,t){return this.on(e,t,!0)},off:function(e,t){var n=this;if(!e||!n.$event$[o](e))return n;if(null==t)delete n.$event$[e];else{for(var r=n.$event$[e],s=r.length-1;s>=0;s--)r[s][0]===t&&t.splice(s,1);r.length||delete n.$event$[e]}return n},emit:function(e,t){var n=this;if(!e||!n.$event$[o](e))return n;var r,s,i=n.$event$[e].slice(),a=i.length,u=[],l={event:e,data:t,target:n};for(r=0;a>r;r++)s=i[r],s[1]&&u.push(r),s[1]&&s[2]||(s[2]=1,s[0](l));for(i=n.$event$[e],r=u.length-1;r>=0;r--)i.splice(u[r],1);return i.length||delete n.$event$[e],n},abort:function(t,n){return this.status=e.Client.ABORTED,!0===t?this.emit("abort",n):this},open:function(t){return this.status=e.Client.OPENED,this.emit("open",t)},close:function(t){return this.status=e.Client.CLOSED,this.emit("close",t)},send:function(e){return this},listen:function(){return this},init:function(){var e=this;return setTimeout(function(){e.listen()},40),e}},e.Client[r].addEventListener=e.Client[r].on,e.Client[r].removeEventListener=e.Client[r].off,e.Client[r].trigger=e.Client[r].dispatchEvent=e.Client[r].emit,e});